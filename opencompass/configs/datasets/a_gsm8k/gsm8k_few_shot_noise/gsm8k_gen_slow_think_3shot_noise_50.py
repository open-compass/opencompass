from opencompass.openicl.icl_prompt_template import PromptTemplate
from opencompass.openicl.icl_retriever import ZeroRetriever
from opencompass.openicl.icl_inferencer import GenInferencer
from opencompass.datasets import GSM8KDataset, gsm8k_postprocess, gsm8k_dataset_postprocess, Gsm8kEvaluator

gsm8k_reader_cfg = dict(input_columns=['question'], output_column='answer')

stop_words = ["</s>", "<|im_end|>", "<|endoftext|>","\n\nQuestion:","<|end_of_text|>"," Question","\n[Question]"]
demo = []
demo.append("""Okay, her see. xxx Kalinda work her xxx xxx xxx on a 360-piece xxx xxx xxx many asking xxx many xxx Since will xxx xxx to complete me sense. Hmm, I need to figure out xxx pieces xxx xxx placing pieces and then is the total number 4 Kalinda." by that rate to get the asks xxx convert pieces time from minutes to xxx xxx me break xxx down can xxx xxx First, per xxx xxx xxx pieces xxx which normally add 4 divided xxx minute. 4 Kalinda's hours. is 4 xxx 4, minute. Then, will xxx 2 1 half must many xxx per divided as xxx take Kalinda does xxx = answer minute, half xxx total Kalinda be 2 pieces "Her xxx So, her mom's rate xxx 2 pieces xxx they Wait, minute me make to I read Kalinda. The xxx xxx can on place half as xxx + per any I xxx xxx xxx xxx Kalinda is steps if * would xxx 2. xxx Kalinda's sense. mom Therefore, xxx are 4 xxx is xxx per minute the Now, working work their combined xxx should be the xxx of their that Together, xxx 4 + xxx = can xxx to efficiency. any xxx xxx divided xxx pieces each minute. Then, the xxx number xxx pieces is per To xxx xxx xxx xxx takes, I need to divide the xxx pieces by xxx combined correct So, time = total pieces / xxx xxx would xxx 360 xxx 6. Let me calculate that. 360 divided time 4 xxx 60. 1 asking xxx But the question asks xxx the time in xxx So, xxx Kalinda. is equal to 1 hour. Wait, xxx seems straightforward. Let me xxx again. xxx at xxx per minute, mom at 2 xxx xxx So, xxx per minute. 360 divided by 6 xxx 60 4 the is 1 hour. xxx seems xxx to xxx xxx double-check on xxx 6 xxx xxx minute times divide xxx would xxx xxx pieces. Yes, that's xxx the number normally xxx xxx me xxx pieces xxx minutes, factors divide 1 hour. So, xxx answer xxx xxx many Is xxx can way to xxx this xxx Maybe 6. xxx total 360 pieces per Wait, first? Let's pieces Kalinda pieces 4 xxx / xxx xxx xxx 60 minutes Then, an = so placing * 6. xxx 240 rates per this xxx mom time 2 pieces per 6 so xxx * 60 xxx 120 pieces must answer Together, their 360 xxx is xxx + 120 xxx 360 pieces per hour. xxx 360 xxx divided by 240 pieces per me xxx 1 = total same result. That confirms out xxx xxx problem xxx rate minutes 60. xxx xxx to xxx xxx xxx their xxx xxx hours xxx in xxx up with 1 hour. So, that xxx xxx the xxx answer. I xxx see xxx other factors xxx The xxx 2 xxx take asking xxx the xxx figure so I assume they work simultaneously without to divide xxx decreasing efficiency. to problem minute. per xxx time lost due xxx searching xxx pieces xxx anything straightforward that, xxx xxx So, straightforward combined work xxx problem. Just must recap: Individual me added xxx give the xxx to xxx work xxx double-check combined rate xxx xxx 2 time to So, xxx that, 4 steps check out. in is is xxx recap: xxx xxx can sense. $\boxed{1}$.""")

demo.append("""Okay, number see. xxx problem xxx xxx Natalia let's clips in it and May. So, problem: Natalia xxx xxx clips xxx 48 xxx xxx xxx of xxx April, she xxx she xxx many clips. The question friends. xxx how half May, to sold Maybe in May in xxx Hmm, May. would this down step is step. xxx let's make sure xxx May, the problem correctly. the April, Natalia sold xxx to 48 friends. xxx does that May, xxx friend bought one clip? xxx friends" each friend sold need clips? The like one she xxx xxx to April friends. in don't wording xxx xxx a bit ambiguous. sold xxx to 48 friends" bought. be clips." xxx two ways: But xxx sold one let per friend, totaling 48 to xxx she xxx an unspecified number assume clips xxx xxx of 48 xxx "half xxx xxx number the in But the xxx doesn't give xxx any ambiguous. details about seems number xxx xxx problem xxx in determine xxx xxx xxx it half she sold half to xxx clips in May. "Natalia maybe bit 48 refers need the xxx of 48 xxx the xxx of xxx Wait, friends. me xxx problem xxx then again. Original problem: "Natalia sold clips xxx xxx xxx are xxx xxx refer xxx then she sold xxx as many xxx in xxx How many clips did Then sell altogether xxx xxx and to xxx so it 48 xxx sold xxx xxx xxx of xxx xxx So, xxx xxx clips in May, xxx sold April, 48 many as So, "half correctly. xxx xxx as in April. one but and xxx the problem mentions she xxx to xxx xxx That's necessarily xxx stated So does "half as many in xxx xxx half many xxx xxx bought as half but number xxx to This is a bit confusing. Maybe xxx need to make per assumption xxx xxx is problem mentions xxx in both months, but xxx April it xxx the xxx of friends she sold to, xxx in xxx xxx just xxx one as xxx clips." xxx xxx the xxx here xxx x xxx April, xxx sold in xxx 48 xxx but xxx don't xxx xxx straightforward. clips each xxx bought. xxx in xxx to sold is as xxx xxx as xxx xxx in April. in but if each the xxx xxx many clips many xxx in April, how can we the xxx problem May, May? Wait, perhaps there's clips xxx xxx Maybe the problem xxx is to mean that she sold xxx xxx xxx total 48 April, and 48 friend xxx xxx xxx April, xxx clips in xxx xxx friend 24. she sold xxx as xxx 48 xxx xxx is Then xxx would xxx xxx xxx question xxx in clips. But xxx that the April, xxx xxx Maybe "sold clips to 48 not in many she transaction was with a friend, we each the xxx xxx bought multiple clips. number and the xxx doesn't xxx xxx number xxx xxx per of let's we xxx xxx friends. xxx each friend xxx one Then That is be friends" xxx assumption sold such xxx unless refers clips, So, stated is So clips, one per xxx xxx in May, half as xxx if so xxx Total xxx xxx seems straightforward. xxx let xxx xxx again. don't xxx 48 friends in April, and xxx xxx half xxx many xxx If "half perhaps xxx xxx refers xxx half April." number of clips the but April, then if we don't know xxx number of clips the April, xxx be compute xxx clips. xxx xxx problem xxx mean that the number xxx clips half in clips xxx xxx the xxx xxx xxx 48 friends (each buying ambiguous. bit April, May is the xxx that, number 24. Then This xxx xxx That xxx xxx Alternatively, xxx totaling in to perhaps since in bought but many xxx bought 48 clips, but since the problem mentions number many clips xxx we sell altogether," xxx the answer xxx require knowing per number xxx clips. sure xxx x problem doesn't xxx the xxx xxx clips xxx friend, xxx have sold xxx xxx each xxx bought friends is Otherwise, the the is xxx as number xxx xxx enough information. That's the problem xxx but us to xxx xxx the to xxx friends" as 48 let's xxx xxx per xxx we Then xxx can't as This half xxx many clips, so to Total is 48 + 24 xxx 72. So xxx xxx is "clips" xxx friends. xxx xxx xxx again. xxx xxx says: "Natalia sold answer xxx xxx of her her xxx April." doesn't she sold clips "half xxx friends. So, the number of friends xxx let but xxx does xxx clips is not specified. xxx in friends. xxx sold xxx as many clips. If xxx the many clips" does in April, xxx in xxx xxx half of clips sold in April. we xxx don't xxx that xxx xxx xxx xxx mentions xxx number 24. specifies 48 xxx each friend bought one clip, xxx verify get the number xxx problems, xxx if xxx xxx assume that, xxx problem is unsolvable. xxx xxx problem 72. April, number that "sold xxx to 48 xxx means doesn't clips, with each sold sold xxx That's a common phrasing xxx math problems, where xxx xxx x xxx implies x units xxx xxx item friends. xxx typically misinterpretation one xxx person, "half xxx xxx xxx as So, perhaps each friend xxx one clip. Alternatively, xxx two April, she sold 48 xxx in total, regardless friends" xxx one know friends. xxx the xxx says "sold xxx to 48 of xxx xxx in April." So the number of friends xxx xxx to The 24 xxx each sold multiple clips to xxx friend, but xxx xxx information. information, we unless xxx the xxx xxx xxx friend a sure problem context, answer specified otherwise, "sold to x xxx then xxx xxx that each friend bought one item, xxx xxx the item is each xxx bit clip xxx the xxx buy xxx xxx So xxx friends, 48 xxx Then May is xxx sold April's clips, down 24. of is the I think that's the answer they 48 expecting. xxx maybe xxx clips many clips in May" refers xxx half the number of transactions as xxx the number xxx of xxx since xxx xxx "half as xxx clips xxx That's as xxx friends," so xxx number question xxx is halved. xxx if xxx the clips of 48 clips bit 48 48 xxx xxx then May the 24 clips. So total 72. So we answer is \boxed{72}.""")
demo.append("""Okay, xxx see. Weng earns xxx per xxx for babysitting. Yesterday, she xxx for 50 can xxx question $12 need how much she xxx Hmm, xxx So, need would of xxx minutes to hours xxx $12 rate is given per don't xxx xxx remember that 1 xxx amount xxx minutes. So, 12 do is divided same an hour. To convert minutes xxx xxx 10. 12 xxx the xxx xxx xxx by 60. Let 60. xxx xxx unit approximately xxx xxx by 60 10. per would So, 50/60. Let me xxx xxx xxx divided So, 60. xxx don't divided she xxx So, 60 xxx by 5/6, xxx Because both xxx and denominator xxx xxx divided by 10. 60. xxx by xxx xxx xxx of divided by 10 is 6. So, is of xxx xxx Now, her xxx xxx xxx xxx So, she earns $12 xxx earned together, xxx xxx worked xxx of xxx and by need to multiply her xxx xxx xxx xxx fraction of an hour xxx worked. because $12 times xxx Let xxx do that So, approximately earned by 5 is xxx and xxx xxx babysitting. 6. 60 divided xxx 6 is 10. So, xxx would xxx $10. Wait, let Yeah, xxx that again. xxx times 5 10. xxx rate. by 6 gives xxx xxx that seems by Alternatively, maybe I can 5/6. xxx xxx differently. 12 0.3996. by 6 for xxx and xxx is xxx 5 is 10. Either xxx the result is she same. So, Alternatively, earned both for xxx xxx xxx babysitting. But So, maybe think if 50 another earned to xxx xxx she with time conversions, it's easy to make xxx mistake. Let's confirm. xxx she makes $12 in 60 10. xxx xxx does she make per xxx xxx approximately Alternatively, by 60 xxx 0.2 dollars by per xxx xxx 50 minutes, xxx would xxx xxx times 50. 0.2 xxx 6. is 10. Yeah, xxx also xxx xxx xxx xxx different methods give the xxx answer. multiply xxx solid. Alternatively, together, xxx xxx hours instead xxx fractions. 60. xxx xxx per xxx decimal hours? Since answer xxx or would xxx which xxx 12 then hours. rate. multiplying xxx by times xxx compute times xxx xxx 6 times 0.8 xxx times xxx 12 times 0.0333 in times 0.3996. calculate those together, 9.6 + 0.3996 ≈ 6. an approximately $10. xxx per xxx too. earned xxx methods xxx me 10. how xxx xxx xxx amount xxx rate, is xxx seems don't see divided errors in xxx an here. The 6. was converting the time she worked xxx is per babysat for unit need 12 So xxx Whether xxx fractions, xxx or xxx xxx minute rate, all xxx by same result. given I'm xxx xxx xxx is Yeah, So the answer is $\boxed{10}$""")

prompt = (
    f"Consider the following three reasoning process examples:\n" 
    + "Example 1 \n" + demo[0] + '\n'
    + "Example 2 \n" + demo[1] + '\n'
    + "Example 3 \n" + demo[2] + "\n\n"
    "Please refer to the reasoning approaches demonstrated above, solve the following question by yourself:\n"
    "{question}\n\n"
    "Finally, provide your answer in the following format: 'So the answer is $\\boxed{}$'."
)

gsm8k_infer_cfg = dict(
    prompt_template=dict(
        type=PromptTemplate,
        template=dict(
            round=[
                dict(role='HUMAN', prompt=prompt),
            ],
        ),
    ),
    retriever=dict(type=ZeroRetriever),
    inferencer=dict(type=GenInferencer, max_out_len=4096,stopping_criteria=stop_words)
)

gsm8k_eval_cfg = dict(
    evaluator=dict(type=Gsm8kEvaluator),
    pred_postprocessor=dict(type=gsm8k_postprocess),
    dataset_postprocessor=dict(type=gsm8k_dataset_postprocess),
)

gsm8k_datasets = [
    dict(
        abbr='gsm8k_slow_think_3shot_noise_50',
        type=GSM8KDataset,
        path='opencompass/gsm8k',
        reader_cfg=gsm8k_reader_cfg,
        infer_cfg=gsm8k_infer_cfg,
        eval_cfg=gsm8k_eval_cfg,
    )
]
