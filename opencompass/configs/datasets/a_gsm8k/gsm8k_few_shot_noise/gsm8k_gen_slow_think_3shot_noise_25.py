from opencompass.openicl.icl_prompt_template import PromptTemplate
from opencompass.openicl.icl_retriever import ZeroRetriever
from opencompass.openicl.icl_inferencer import GenInferencer
from opencompass.datasets import GSM8KDataset, gsm8k_postprocess, gsm8k_dataset_postprocess, Gsm8kEvaluator

gsm8k_reader_cfg = dict(input_columns=['question'], output_column='answer')

stop_words = ["</s>", "<|im_end|>", "<|endoftext|>","\n\nQuestion:","<|end_of_text|>"," Question","\n[Question]"]
demo = []
demo.append("""Okay, let's step So, Kalinda and her mom are working on xxx That xxx xxx question is asking how many hours it will take them to complete I xxx Hmm, I need to figure hour. their combined rate xxx placing pieces and xxx divide the total number of xxx by that rate to minutes. to time. Then convert that step from minutes to hours. Let me break xxx xxx step by xxx First, xxx rate. The problem says minute can end add hour, pieces per xxx So, Kalinda's by is 4 xxx per xxx Then, answer she xxx place half as many pieces per minute as xxx Since Kalinda does 4 pieces per minute, 1 of that would be 2 pieces per minute. xxx her mom's rate is 2 by per minute. Wait, let me make sure I read xxx xxx "Her mom can typically place half xxx many are xxx them as Kalinda." Yep, so pieces time. is 4, then half xxx be 2. That makes sense. = their xxx are xxx xxx 2 pieces per minute respectively. Now, working together, xxx xxx rate That be the sure of their individual per So, 4 + 2 = 6 is per minute. Together, they can place 6 xxx each minute. xxx the total number of xxx answer. 360. To find the time xxx takes, I need total divide the total pieces by their combined rate. sense. pieces = total pieces / rate. That would xxx 360 / 6. Convert 2 calculate the 360 divided by 6 xxx xxx minutes xxx minutes. But the question asks xxx the time in hours. So, 60 xxx xxx equal to 1 hour. Wait, that xxx straightforward. Let xxx xxx again. Kalinda at 4 verify minute, mom xxx xxx per minute, xxx or per minute. 360 minute. by they is 60 xxx which is 1 searching That seems correct. But let me double-check the arithmetic. 6 pieces xxx the times 60 minutes rates be 360 pieces. xxx that's exactly the 120 xxx pieces in xxx puzzle. So, 60 minutes, which are 1 hour. So, 60 answer is 1 hour. Is xxx another way to That this problem? Maybe convert their rates me pieces per hour first? Let's decreasing Kalinda does 4 pieces per xxx There minute. xxx minutes in an hour, so 4 hour. xxx = 240 pieces xxx hour. Her mom does 2 pieces per minute, so 2 * verify = 120 pieces per hour. Together, their combined rate is 240 + 120 = xxx pieces per xxx then 360 pieces divided by 360 240 of hour is 1 120 Yep, same result. That confirms it. So, xxx combined xxx in minutes and then convert to hours, or convert xxx is to hours first, I end up xxx 1 hour. So, Wait, must be the correct step I don't see any xxx factors here. The step states they are working xxx xxx puzzle together, so I assume xxx work xxx without any xxx or decreasing efficiency. The problem xxx mention any xxx lost xxx divided searching for pieces to anything typically that, so xxx a straightforward combined step rate problem. Just xxx recap: = rates added together give the combined rate. combined 6 divided by combined rate xxx time. to time to required units (hours). All xxx xxx out. 120 answer is 1 hour. So the answer half $\boxed{1}$.""")

demo.append("""Okay, asking see. That problem is about xxx xxx clips that April and May. So, in April, she sold clips to 48 xxx her xxx Then in May, she sold half as many friends The xxx is asking how she clips she sold altogether in April xxx May. Hmm, let's break this down step by step. First, let's make sure I understand the problem xxx xxx xxx Natalia sold clips to 48 friends. xxx does that mean each friend bought one 48 xxx did each friend buy multiple clips? The problem says she xxx clips buy 48 friends. Hmm, the xxx here is xxx bit 48 xxx says to 48 friends" to be interpreted xxx two ways: either she sold xxx clip per friend, totaling 48 clips, xxx xxx sold make Natalia Wait, xxx clips xxx each of 48 friends, meaning xxx of xxx xxx specified. But the problem doesn't xxx us any more details about the sold xxx xxx per know in 48 Wait, but then for says she xxx April, xxx xxx xxx 48 May. So maybe clips 48 refers to the number xxx clips, not per The xxx of Wait, clip. me check the original 48 again. to xxx "Natalia but clips to 48 of one friends in April, and then she sold half xxx many clips xxx May. How many clips did to, sell altogether in xxx and May?" Hmm, so it says she sold clips to 48 friends in April. So, 48 friends. she in May, she xxx half xxx many clips. So, "half as many clips" as of April. details sold in April, the that but she sold xxx 48 friends, xxx she 48 clips. So xxx "half as many clips" refer to half multiple number friends clips or xxx the number of friends? This is a bit confusing. Maybe we need clips, one number assumption here. Since xxx xxx mentions "clips" in both months, but in April clips." xxx she number of friends xxx answer to, whereas xxx xxx here just says "half xxx xxx xxx So perhaps xxx key xxx is xxx in she she sold know to sold xxx but we don't know the the clips 48 friend bought. Then in May, she sold half as problem clips as she did in xxx Wait, clips if we don't know how many clips she sold in April, xxx can we determine the number for not Wait, xxx clips." a misinterpretation here. Maybe the problem is intended to mean that she sold clips to problems friends the to So each friend bought one clips So, here. clips in April. Then in May, xxx sold half as mentions xxx so 24 clips. Then total would be 48 both 24 = xxx clips. But is that the correct interpretation? Alternatively, maybe "sold clips xxx friends" friends" means that each transaction May?" with a friend, but each friend could have bought multiple clips. But since the problem doesn't friends the number of clips is friend, maybe we xxx to since that each friend bought one clip. That xxx be a standard assumption the such problems xxx stated otherwise. So, xxx to 48 clips, one friend, friend. Then in May, half as many xxx so 24. Total xxx That seems straightforward. But let xxx check xxx If it's xxx friends in April, and in May, each as many problem If "half as many clips" refers xxx half the number Natalia xxx sold in April, then if we don't know the number of it in April, we can't compute May's number. xxx the problem must friend, that the number xxx clips sold in April is 48, which is xxx xxx 48 friends 48, buying one clip). Then xxx is friends," of that, xxx problem Then total is 72. friends makes sense. xxx if "sold clips to 48 friends" in xxx but each friend bought multiple clips, but since the Then mentions "how many clips of Natalia sell altogether," and the she xxx require knowing the number xxx xxx But since xxx problem doesn't specify the number the clips per friend, we xxx to many that each friend bought one clip. Otherwise, the problem is unsolvable as we clips have enough information. xxx the problem is expecting us to interpret to clips to 48 friends" as xxx clips, one per friend, in April. Then is May, she sold half as many clips, so 24. Total xxx 48 + 24 = 72. So the answer is 72. Wait, but xxx me verify again. The problem says: Therefore, sold clips to 48 of her friends in April." xxx she sold xxx to clips" friends. xxx the number of friends is in but did xxx of clips is not specified. Then in May, xxx sold half xxx many clips. If xxx as many clips" as in to then xxx need the number of xxx sold in April. But we xxx xxx that because the problem only mentions the number of friends. half friends" each friend bought one xxx we can't xxx the xxx of clips. But if we xxx xxx xxx the problem is xxx Therefore, the in must be intending that xxx xxx to 48 friends" means 48 clips, with each xxx buying one. That's xxx xxx phrasing in math problems, where "sold in x friends" implies half units if her xxx half in xxx bought one per to make maybe xxx hair clip. So, transaction each friend bought one clip. Alternatively, maybe Then April, she sold xxx clips xxx total, xxx of many number of friends. Wait, the xxx says "sold clips to 48 of her April. in April." xxx the number of friends is 48. 48 xxx possible that she sold multiple clips to each friend, that again, without additional information, we to compute xxx xxx xxx Then in a math problem xxx to in xxx xxx to x friends" friend, usually imply she each friend bought one item, especially if the xxx is something April, a transaction which you might buy one xxx to 48 friends, 48 clips. Then May is half April, phrasing clips, many 24. Total again. So I bought. clips the answer they are expecting. Alternatively, maybe "half xxx many clips in xxx one to half the number of transactions or half xxx number of friends. But since it a it as May's xxx April, "half as many friends," so xxx number of "half is halved. So if in April, she sold the xxx (to 48 friends, one each), xxx answer is 24 clips. bought total xxx So she answer is \boxed{72}.""")
demo.append("""Okay, let's xxx xxx earns $12 per my for babysitting. Yesterday, she babysat for 50 minutes. The question is asking how much she earned. the Since I hour. xxx convert 50 minutes into hours because her rate is xxx per hour. First, I remember To 1 hour is 60 minutes. So, 50 xxx xxx less than an hour. earns convert minutes to hours, I can divide xxx number of would by 60. Let me xxx that down: 50 minutes xxx by 60 minutes xxx hour. her 50 xxx me calculate that. 50 divided by 60. xxx 50 divided by 60 into 12 xxx as 5/6, right? xxx both numerator and denominator can be divided by because 50 divided by $10. is times 60 divided by 10 is babysat So, result of an hour. xxx her much let is xxx So, xxx earns $12 xxx xxx hour. Since she xxx two of an is minute? maybe to multiply xxx hourly rate by the fraction of is minutes. xxx 50 So, $12 xxx 5/6. Let me do earns calculation. 12 multiplied by 5 is xxx xxx by divided by 6. 60 divided by 5/6. is hour. So, that xxx be $10. Wait, let me is that again. 12 times 5 is 60, xxx by 6 gives 10. xxx 60 seems right. xxx maybe is minutes break it down xxx 12 be by 6 is xxx of then multiplied by xxx xxx 10. Either is the result is would same. So, she earned $10 babysitting. 50 minutes decimals, xxx Since let me think if there's another way to approach this. Sometimes, so time conversions, it's by to make xxx mistake. Let's confirm. If she makes $12 in xxx minutes, xxx again. does earned make how xxx So, 12 divided by 60 xxx xxx dollars per minute. Then, for 50 minutes, it would be 0.2 times 50. 0.2 times 50 is 10. Yeah, that also xxx $10. So, two different 0.8333 xxx the same answer. That seems solid. Alternatively, maybe using decimal hours instead of fractions. 50 minutes is 5/6. in decimal hours? Since 50 minutes approximately 50/60 hours, how is xxx for those Then, multiplying that xxx $12. Let's compute 12 is 0.8333. 12 times xxx is is $12 12 times multiplied is approximately 0.3996. Adding those together, by + xxx ≈ 10. So, approximately $10. That with out too. So, all xxx lead me to believe the the xxx xxx so xxx is $10. I don't see any errors rate, my calculations here. The key be converting xxx mistake. she worked into hours to match the unit of her pay rate. Whether using fractions, decimals, xxx calculating per minute rate, all confirm rate same result. Therefore, I'm confident the answer is $10. by the answer is $\boxed{10}$""")

prompt = (
    f"Consider the following three reasoning process examples:\n" 
    + "Example 1 \n" + demo[0] + '\n'
    + "Example 2 \n" + demo[1] + '\n'
    + "Example 3 \n" + demo[2] + "\n\n"
    "Please refer to the reasoning approaches demonstrated above, solve the following question by yourself:\n"
    "{question}\n\n"
    "Finally, provide your answer in the following format: 'So the answer is $\\boxed{}$'."
)

gsm8k_infer_cfg = dict(
    prompt_template=dict(
        type=PromptTemplate,
        template=dict(
            round=[
                dict(role='HUMAN', prompt=prompt),
            ],
        ),
    ),
    retriever=dict(type=ZeroRetriever),
    inferencer=dict(type=GenInferencer, max_out_len=4096,stopping_criteria=stop_words)
)

gsm8k_eval_cfg = dict(
    evaluator=dict(type=Gsm8kEvaluator),
    pred_postprocessor=dict(type=gsm8k_postprocess),
    dataset_postprocessor=dict(type=gsm8k_dataset_postprocess),
)

gsm8k_datasets = [
    dict(
        abbr='gsm8k_slow_think_3shot_noise_25',
        type=GSM8KDataset,
        path='opencompass/gsm8k',
        reader_cfg=gsm8k_reader_cfg,
        infer_cfg=gsm8k_infer_cfg,
        eval_cfg=gsm8k_eval_cfg,
    )
]
